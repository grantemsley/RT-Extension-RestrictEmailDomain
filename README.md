
# RT::Extension::RestrictEmailDomain

Enforce allowed email domains for **Requestor**, **Cc**, and **AdminCc**.

- **Web UI (main + Self Service)**: server-side Mason callbacks validate and block saves so users can correct addresses before saving.
- **Mailgate**: RT::Interface::Email `BeforeCreate` callback scrubs disallowed addresses before `Ticket->Create`.

## AI Use

Most of this was generated by AI, but manually reviewed and edited.

## Compatibility

Tested with **Request Tracker 6.0.2**.

## Installation

```bash
perl Makefile.PL
make
make install
```

Enable and configure in `RT_SiteConfig.pm`:

```perl
Set(@Plugins, qw(
    RT::Extension::RestrictEmailDomain
));

Set(%RestrictEmailDomain,
    AllowedDomains  => ['example.com'], # REQUIRED to activate
    AllowSubdomains => 0,               # 1 to accept foo.bar.example.com
);
```

## How it works

- UI callbacks on `Ticket/Create.html` (BeforeCreate), `Ticket/ModifyPeople.html` (BeforeProcess), `SelfService/Create.html` (BeforeCreate), and `SelfService/Update.html` (BeforeProcess) call `ValidateEmailAddresses($ARGSRef)`. They push errors and set skip flags to block save if any disallowed address is present.
- Mailgate callback `RT::Interface::Email` (BeforeCreate) calls `FilterTicketArgs($TicketArgs)` to remove disallowed Requestor/Cc/AdminCc.

## Configuration

- `AllowedDomains` (ArrayRef<Str>) — required; if empty or unset, plugin is disabled (no-op).
- `AllowSubdomains` (Bool) — default 0; if 1, `foo.bar.example.com` is allowed when `example.com` is listed.

## Notes

- If the email From/Requestor is disallowed, the ticket will be created without a Requestor (valid in RT but may affect notifications).
- The plugin logs removals during the email path at INFO level.

## Tests

Run:

```bash
prove -lv t
```
