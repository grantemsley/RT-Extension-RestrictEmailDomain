
# RT::Extension::RestrictEmailDomain

Enforce allowed email domains for **Requestor**, **Cc**, and **AdminCc**.

- **Web UI (main + Self Service)**: server-side Mason callbacks validate and block saves so users can correct addresses before saving on the create pages. Overlay blocks adding though all of the modify pages. 
- **Mailgate**: RT::Interface::Email `BeforeCreate` callback scrubs disallowed addresses before `Ticket->Create`.

## AI Use

Some of this was generated by AI, but manually reviewed, edited and changed to actually work.

## Compatibility

Tested with **Request Tracker 6.0.2**.

## Installation

```bash
perl Makefile.PL
make
make install
```

Enable and configure in `RT_SiteConfig.pm`:

```perl
Set(@Plugins, qw(
    RT::Extension::RestrictEmailDomain
));

Set(%RestrictEmailDomain,
    AllowedDomains  => ['example.com'], # REQUIRED to activate
    AllowSubdomains => 0,               # 1 to accept foo.bar.example.com
);
```

## How it works

- UI callbacks on `Ticket/Create.html` (BeforeCreate), `SelfService/Create.html` (BeforeCreate) call `ValidateEmailAddresses($ARGSRef)`. They push errors and set skip flags to block save if any disallowed address is present.
- Mailgate callback `RT::Interface::Email` (BeforeCreate) calls `FilterTicketArgs($TicketArgs)` to remove disallowed Requestor/Cc/AdminCc.
- Additional overlay for RT::User ValidateEmailAddress prevents creating users with email addresses that aren't in the allowed domains. This blocks them from being added via the ModifyPeople, ModifyAll or quick edit methods where there are no callbacks available to stop it. Unfortunately the error isn't as clear as I would like about why.

## Configuration

- `AllowedDomains` (ArrayRef<Str>) — required; if empty or unset, plugin is disabled (no-op).
- `AllowSubdomains` (Bool) — default 0; if 1, `foo.bar.example.com` is allowed when `example.com` is listed.

## Notes

- If the email From/Requestor is disallowed, the ticket will be created without a Requestor (valid in RT but may affect notifications).
- The plugin logs removals during the email path at INFO level.

## Changelog

### Version 1.2.1

Added support for forms created by FormTools. At the moment this requires a callback that hasn't been added yet - see [this pull request](https://github.com/bestpractical/rt-extension-formtools/pull/11).
